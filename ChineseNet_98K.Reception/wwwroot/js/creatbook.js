$(function(){function e(e,t){clearTimeout(c),l.find(".autosave").size()>0&&l.find(".autosave").remove();var i="";i=e>0?'<div class="autosave"><p class="save_succ"><em class="pub_ico ico_succ"></em>'+t+"</p></div>":'<div class="autosave"><p class="save_error"><em class="pub_ico ico_err"></em>'+t+"</p></div>",l.append(i),c=setTimeout(function(){l.find(".autosave").fadeOut()},3e3)}function t(e){w-=1;if((i=u.indexOf(e))<0)return!1;for(var t=u.split(" "),i=0;i<t.length;i++)t[i]==e&&t.remove(i);u=t.join(" ")}function i(e){if((w+=1)>I)return publicDialog("作品关键字","作品关键字个数不能超过5个，请删除后再添加",0),w=I,!1;var t='<a href="javascript:;"><span class="keyval">'+e.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+'</span><em class="delkey pub_ico"></em></a>';v.find(".add_btn").before(t);for(var i=b.children("a"),a=0;a<i.length;a++)i.eq(a).text()==e&&i.eq(a).addClass("focus").append('<em class="pub_ico choice"></em>');u+=" "+e}function a(e){if(0==f){if("zh"==h.find(".au_keys").data("load"))return!1;h.find(".au_keys").data("load","zh")}else{if("mm"==h.find(".au_keys").data("load"))return!1;h.find(".au_keys").data("load","mm")}var t=e,i=[],a="";i=u.split(" ");for(var s=0,r=t.length;s<r;s++){var n=t[s];i.inArry(n)?a+='<a class="focus" href="javascript:;">'+n.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+'<em class="pub_ico choice"></em></a>':a+='<a href="javascript:;">'+n.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</a>"}h.find(".keyword").siblings("a").remove(),h.find(".au_keys").find(".akeys").prepend(a).scrollTop(0)}function s(e){var t=$(e),i=t.next(".au_cor_gay"),a=(t.attr("maxlength"),$.trim(t.val()).length);if(a<=400)i.html(a+"/400");else{var s=Math.abs(a-400);i.html("您已超出"+s+"个字")}}function r(e,t){_.find(".sel_con").empty(),_.find(".option").empty(),k.find(".sel_con").empty(),k.find(".option").empty();for(var i="",a="",s=0,r=d.length;s<r;s++){if(d[s].cateId==e){_.find(".sel_con").text(d[s].cateName).attr("cateid",d[s].cateId);for(var n=d[s].cateList,o=0,l=n.length;o<l;o++)n[o].cateId==t&&k.find(".sel_con").text(n[o].cateName).attr("cateid",n[o].cateId),a+=0==o?'<li cateid="'+n[o].cateId+'" class="checked">'+n[o].cateName.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</li>":'<li cateid="'+n[o].cateId+'">'+n[o].cateName.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</li>";k.find(".option").html(a)}i+='<li cateid="'+d[s].cateId+'">'+d[s].cateName.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</li>"}_.find(".option").html(i)}function n(t){var i=_.find(".sel_con").attr("cateid"),a=k.find(".sel_con").attr("cateid"),s=m>0?u:u.substr(1,u.length),r=$.trim(p.val()),n=$.trim(g.val()),l=$.trim(h.find(".bookintro[name='description']").val()),c=h.find(".bookintro[name='wishWord']").length>0?$.trim(h.find(".bookintro[name='wishWord']").val()):"暂无寄语";if(""==r)return p.focus(),$(window).scrollTop(165),!1;if(""==n)return e(-1,"作品首字母不能为空"),g.focus(),$(window).scrollTop(435),!1;if(""==l)return e(-1,"作品简介不能为空"),h.find(".bookintro").focus(),!1;if(""==s)return e(-1,"关键字不能为空"),!1;var d={bookName:r,catePid:i,cateId:a,firstLetter:n,keyWord:s,description:l,wishWord:c};if(m>0){null!=(v=h.attr("coverfile"))&&(d.coverUrl=v),d.bookId=m,o("/book/editsubmit",d,t)}else{d.siteType=f;var v=h.attr("coverfile");null!=v&&(d.coverUrl=v),o("/book/addsubmit",d,t)}}function o(t,i,a){h.find(".sensitive").size()>0&&h.find(".sensitive").fadeOut(),$.ajax({type:"post",url:t,data:i,dataType:"json",error:function(t){e(-1,t.message||"出错啦，请您重试！")},success:function(t){if(null==t||""==t)return!1;if(200==t.code)location.href=0==a&&""==m?"http://"+location.hostname+"/book/chapter/show?bookId="+t.result:"http://"+location.hostname;else if(501==t.code){for(var i=t.result,s="",r=0,n=i.length;r<n;r++)s+="<em>"+i[r]+"</em>";if(h.find(".sensitive").size()>0)h.find(".sensitive").fadeIn().find(".sens_word").empty().html(s);else{var o='<div class="sensitive" style="display:block"><div class="senspad"><p><em class="pub_ico ico_err"></em>内容中包含敏感词：<span class="strong">'+s+"</span></p></div></div>";h.prepend(o)}$(window).scrollTop(0)}else e(-1,t.message)}})}$(".au_nav").addClass("fixed"),$(".au_create").css("padding-top","90px");var l=$(".au_nav").find(".au_box");!function(e){var t='<a href="'+(document.referrer||"http://"+location.host)+'" style="float:right; font-size:14px; color:#1abc9c; letter-spacing:1px;font-family:\'Microsoft YaHei\';line-height:40px;margin-left:10px;">返回<em style="letter-spacing:-2px; padding-left:2px;">&gt;&gt;</em></a>';e.find(".note").before(t)}($(".au_c_tit").eq(0));var c=null,d=cateJson,f=0,u="",m=$("body").attr("bookid"),h=$(".au_c_form"),p=h.find(".bookvalue"),g=h.find(".bookstr"),v=h.find(".au_key"),b=h.find(".akeys"),_=h.find(".kindlist_ul"),k=h.find(".kindlist_li"),y=/<\/?[^>]*>/g,x=/^[a-zA-Z]+$/;if(Array.prototype.remove=function(e){if(isNaN(e)||e>this.length)return!1;for(var t=0,i=0;t<this.length;t++)this[t]!=this[e]&&(this[i++]=this[t]);this.length-=1},Array.prototype.inArry=function(e){if(this.length<1)return!1;for(var t=!1,i=0;i<this.length;i++)this[i]==e&&(t=!0);return t},m>0)h.find(".nextstep").html("保存").siblings(".addstore").remove(),$.ajax({type:"post",url:"/book/get",data:{bookId:m},dataType:"json",error:function(t){if(null==t.message||""==t.message)return!1;e(-1,t.message)},success:function(t){if(null==t||""==t)return!1;if(200==t.code){var i=t.result;console.log(i),p.val(i.bookName),g.val(i.firstLetter),-1!=i.status&&10!=i.status&&(2==i.status&&(p.attr("readonly","readonly"),g.attr("readonly","readonly"),$("#uploadbtn").hide().siblings(".uploadarea").show()),$(".select_nav").unbind("click").css("cursor","text").find(".arr_select").hide().siblings(".sel_con").css("cursor","text"));var a=h.find(".bookintro[name='description']"),s=h.find(".bookintro[name='wishWord']"),n=a.attr("maxlength"),o=s.attr("maxlength"),l=i.description.length,c=0;i.wishWord&&(c=i.wishWord.length),a.val(i.description).next(".au_cor_gay").html(l+"/"+n),s.val(i.wishWord).next(".au_cor_gay").html(c+"/"+o),h.attr("coverfile",i.coverUrl),h.find(".uploadarea").show();var m=i.coverUrl;console.log(i),null!=m&&h.attr("coverUrl",m).find(".uploading").show().find(".loadimg").attr("src","http://static.zongheng.com/upload"+m);var b=[],_=i.keyWord;b=_.indexOf(",")>0?_.split(","):_.split(" "),u=b.join(" "),w=b.length;for(var k="",y=0,l=b.length;y<l;y++)k+='<a href="javascript:;"><span class="keyval">'+b[y].replace(/\</g,"&lt;").replace(/\>/g,"&gt")+'</span><em class="delkey pub_ico"></em></a>';v.find(".add_btn").before(k);var x=i.siteType;f=x,d=1==x?mmCateJson:cateJson,h.find(".label").eq(x).attr("class","label focus").siblings(".label").attr("class","label not-allowed"),r(i.catePid,i.cateId)}else e(-1,t.message)}});else{r(d[0].cateId,d[0].cateList[0].cateId)}g.keyup(function(){var e=$(this),t=e.siblings(".au_error"),i=$.trim(e.val());if(""==i)return e.val(""),!1;x.test(i)?t.hide():t.html('<em class="ico_err pub_ico"></em>请输入英文字母，不区分大小写').show()}).blur(function(){var e=$(this),t=e.siblings(".au_error"),i=$.trim(e.val());if(""==i)return e.val(""),t.html('<em class="ico_err pub_ico"></em>作品首字母不能为空').show(),!1;x.test(i)?t.hide():t.html('<em class="ico_err pub_ico"></em>请输入英文字母，不区分大小写').show()});var I=5,w=0;b.on("click","a",function(){var e=$(this);if(e.hasClass("keyword"))return!1;var a=e.text(),s=e.text();if(e.hasClass("focus")){e.removeClass("focus");e.find("em").remove(),t(s);for(var r=v.children("a"),n=0;n<r.length;n++)r.eq(n).text()==a&&r.eq(n).remove()}else i(s)}),v.on("click",".delkey",function(){var e=$(this).parent(),i=e.find(".keyval").html();e.remove(),t(i);for(var i=b.children("a"),a=0;a<i.length;a++)i.eq(a).text()==value&&i.eq(a).removeClass("focus").children(".choice").remove()}),h.find(".add_btn").click(function(){if(h.find(".au_keys").is(":visible"))return!1;a(0==f?zhKeyWordJson:mmKeyWordJson),h.find(".au_keys").show()}),h.find(".closekey").click(function(){h.find(".au_keys").hide().find(".custom").val("")}),h.find(".addkey").click(function(){var e=$(this),t=$.trim(e.siblings(".custom").val());if(""==t||t.length>6)return!1;if(/<\/?[^>]*>/g.test(t))return publicDialog("作品关键字","关键字格式有误",0,function(){e.siblings(".custom").focus().select()}),!1;return u.split(" ").inArry(t)?(publicDialog("作品关键字","关键字已存在，请重新填写",0,function(){e.siblings(".custom").focus().select()}),!1):w>=I?(publicDialog("作品关键字","作品关键字个数不能超过5个，请删除后再添加",0),!1):(i(t),void e.siblings(".custom").val(""))}),h.find(".bookintro").keyup(function(e){s(this)}),s(),h.find(".radio_dom").find(".label").click(function(){var e=$(this),t=e.index();if(e.hasClass("not-allowed")||t==f)return!1;0==t?(d=cateJson,f=0,a(zhKeyWordJson)):(d=mmCateJson,f=1,a(mmKeyWordJson));r(d[0].cateId,d[0].cateList[0].cateId),v.find(".delkey").click()}),h.find(".nextstep").click(function(){n($(this).index())}),h.find(".addstore").click(function(){n($(this).index())}),p.keyup(function(){if(m>0)return!1;var e=$(this),t=$.trim(e.val());return""==t?(e.siblings(".through").fadeOut(),e.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>书名不能为空").fadeIn(),!1):y.test(t)?(y.lastIndex=0,e.siblings(".through").fadeOut(),e.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>您输入的书名格式有误").fadeIn(),!1):void 0}).focus(function(){if(m>0)return!1;var e=$(this),t=$.trim(e.val());return""==t?(e.siblings(".through").fadeOut(),e.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>书名不能为空").fadeIn(),!1):y.test(t)?(y.lastIndex=0,e.siblings(".through").fadeOut(),e.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>您输入的书名格式有误").fadeIn(),!1):void 0}).blur(function(){var t=$(this);if("readonly"==t.attr("readonly"))return!1;!function(t){var i=$.trim(t.val());if(""==i)return t.siblings(".through").fadeOut(),t.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>书名不能为空").fadeIn(),!1;if(y.test(i))return y.lastIndex=0,t.siblings(".through").fadeOut(),t.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>您输入的书名格式有误").fadeIn(),!1;var a={bookName:i};m>0&&(a.bookId=m),$.ajax({type:"post",url:"/book/checkbookname",data:a,dataType:"json",error:function(t){if(null==t.message||""==t.message)return!1;e(-1,t.message)},success:function(e){if(null==e||""==e)return!1;200==e.code?(t.siblings(".through").fadeIn(),t.parent().siblings(".au_error").fadeOut()):(t.siblings(".through").fadeOut(),e.message?t.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>"+e.message).fadeIn():t.parent().siblings(".au_error").html("<em class='ico_err pub_ico'></em>").fadeIn())}})}(t)}),_.find(".au_s_list").on("click","li",function(){var e=$(this);if(e.hasClass("checked"))return!1;e.addClass("checked").siblings().removeClass("checked");var t=e.index();_.find(".sel_con").attr("cateid",d[t].cateId),k.find(".sel_con").empty(),k.find(".option").empty();for(var i=d[t].cateList,a="",s=0,r=i.length;s<r;s++)0==s?(a+='<li cateid="'+i[s].cateId+'" class="checked">'+i[s].cateName.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</li>",k.find(".sel_con").text(i[s].cateName).attr("cateid",i[s].cateId)):a+='<li cateid="'+i[s].cateId+'" class="checked">'+i[s].cateName.replace(/\</g,"&lt;").replace(/\>/g,"&gt")+"</li>";k.find(".option").html(a)}),k.find(".au_s_list").on("click","li",function(){var e=$(this).attr("cateid");k.find(".sel_con").attr("cateid",e)})});
