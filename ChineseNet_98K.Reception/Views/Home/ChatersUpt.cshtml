
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>作品专区-管理章节</title>
    <meta name="renderer" content="webkit">
    <link type="text/css" charset="utf-8" href="~/css/public.css" rel="stylesheet" />
    <link type="text/css" charset="utf-8" href="~/css/manage.css" rel="stylesheet" />
    <link type="text/css" charset="utf-8" href="~/css/laydate.css" rel="stylesheet" />
    <link type="text/css" charset="utf-8" href="~/css/laydate(1).css" rel="stylesheet" />
    <script type="text/javascript" src="~/js/x.js"></script>
    <script src="~/jquery-3.1.1.js"></script>
    <script>
        var state = 0;
        state =@ViewBag.Author.IsContract;
        console.log(state);
        $(function () {
            if (state == 0) {
                //禁用vip章节按钮
                document.getElementById('raVip').disabled = true;
            }
             $.ajax({
                url: "/AuthorLR/FtChapters?nid=@ViewBag.NId&cid=@ViewBag.CId",
                type: "post",
                async: false,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    $("[name=VolumeId]").val(data.VolumeId);
                    $("[name=ChapterName]").val(data.ChapterName);
                    $("[name=ChapterContent]").val(data.ChapterContent);
                    $("[name=AuthorDesc]").val(data.AuthorDesc);
                    $("[name=IsVIP]").val(data.IsVIP);
                    $("[name=CreateDate]").val(data.CreateDate);
                    $("[name=State]").val(data.State);
                    $("[name=NovelId]").val(data.NovelId);
                    $("[name=ChapterId]").val(data.ChapterId);
                }
            })
        })

        window.onload = function () {
            //获取文本内容和长度函数
            function txtCount(el) {
                var val = el.value;
                var eLen = val.length;
                return eLen;
            }

            var el = document.getElementById('ChapterContent');
            el.addEventListener('input', function () {
                var len = txtCount(this); //   调用函数
                document.getElementById('showWordNum').innerHTML = len;
            });

            el.addEventListener('propertychange', function () {//兼容IE
                var len = txtCount(this); //   调用函数
                document.getElementById('showWordNum').innerHTML = len;
            });
        }


    </script>
</head>
<body bookid="785763" authorization="3" level="0" serialstatus="0" draftid="" isfemale="0">
    <div class="pub_nav_bg creat_add">
        <div class="au_box">
            <div class="mod_tit">
                <span class="bookname" id="nname">@ViewBag.NovelName</span>
                <a href="/Home/AuthorIndex" class="btn_bg bookstore">作品库</a>
            </div>
        </div>
    </div>
    <div class="pub_con_bg">
        <div class="manage">
            <div id="listerrbg" style="height: 1395px;"></div>
            <div class="errlist" id="listerr">
                <div class="larw"><input type="text" maxlength="20" class="errcopy"></div>
                <div class="errbtns">
                    <a href="javascript:;" class="err_save btn_bg">保存</a>
                    <a href="javascript:;" class="err_cancel btn_fg">取消</a>
                    <a href="javascript:;" class="err_del">删除本卷</a>
                </div>
            </div>
            <div class="side" style="height: 562px;">
                <div class="side_tit">
                    <h2 class="booktome">目录</h2>
                </div>
                <div class="articelist" id="artList" style="height: 523px;">
                    <div class="tomelist" style="height: 473px;">
                        <ul id="listVolumes">
                            @*<li class="l_tome" tomeid="1723344" tomeno="100" tomelevel="0"><p class="art_tit">
                                <em class="l_name" title="作品相关">作品相关</em></p><div class="chapterlist" style="max-height: 433px;"><ul class="art_con"><li class="add_chapter"></li></ul></div></li>

                                <li class="l_tome" tomeid="1723345" tomeno="200" tomelevel="0"><p class="art_tit"><em class="l_name" title="正文">正文</em><span class="mod_ps"><em title="修改卷名" class="modname pub_ico"></em></span></p><div class="chapterlist" style="max-height: 433px;"><ul class="art_con"><li class="add_chapter"></li></ul></div>
                                </li>

                                <li class="addli"><div class="add_tome"><input class="au_input addtome" maxlength="20" placeholder="请输入分卷名" type="text"><p class="adderror"><em class="ico_err pub_ico"></em><em class="error_con">错误信息</em></p><div class="btns"><span class="btn_bg btn_sure">保存</span><span class="btn_fg btn_cancel">取消</span></div></div></li>*@
                        </ul>
                    </div>
                    <p class="creat_tome"></p>
                </div>

            </div>
            <div class="wide" style="min-height: 497px;">
                <div class="wide_arr">
                    <a href="javascript:;" class="pub_ico arr_left"></a>
                </div>
                <div class="sensitive">
                    <div class="senspad">
                        <p><em class="pub_ico ico_err"></em>您输入的内容中包含违禁词: <span class="strong"></span></p>
                    </div>
                </div>
                <div class="bookend">
                    <div class="book_tome"></div>
                    <h2 class="book_chapter"></h2>
                    <div class="book_content"></div>
                    <div class="book_summary" style="display: none;"></div>
                    <div class="book_authorsay"></div>
                </div>
                <form id="form0">

                    <input type="hidden" name="CreateDate" value="" />
                    <input type="hidden" name="State" value="" />
                    <input type="hidden" name="ChapterId"  />
                    <input type="hidden" name="NovelId"  />
                    <div class="coding">
                        <div class="w_list clear">
                            <div class="minstar fl">*</div>
                            <div class="w_con">
                                <div class=" au_select fl select_dom kindlist_li">
                                    <div class="au_input art_name">
                                        <em class="font_c_gray">所在分卷</em>
                                        <select class="df_input chapter_name" name="VolumeId">
                                            <option value="">--请选择--</option>
                                        </select>
                                    </div>


                                </div>
                                <div class="select1 noselect" style="display: none;">
                                    <span class="au_input select select_nav"><em class="font_c_gray">所在分卷</em><em class="sel_con">作品相关</em></span>
                                </div>
                            </div>
                        </div>
                        <div class="w_list clear">
                            <div class="minstar fl">*</div>
                            <div class="w_con">
                                <div class="au_input art_name"><em class="font_c_gray">章节名</em><input type="text" maxlength="20" value="" placeholder="请输入章节名20字以内" class="df_input chapter_name" name="ChapterName"></div>
                                <p class="value_error" style="display: none;"><em class="ico_err pub_ico"></em><em class="error_con">您输入的格式不对</em></p>
                            </div>
                        </div>
                        <div class="w_list clear">
                            <div class="minstar fl">*</div>
                            <div class="w_con">
                                <div class="textarea">
                                    <textarea placeholder="请输入章节内容50000字以内" class="des chapter_content" id="ChapterContent" name="ChapterContent" onKeyDown='if (this.value.length>=5000){event.returnValue=false}'></textarea>
                                    <p class="setfont"><em id="showWordNum">0</em> / 5000</p>
                                </div>
                            </div>
                        </div>
                        <div class="w_list clear remark" style="display: none;">
                            <div class="minstar fl"></div>
                            <div class="w_con">
                                <div class="authorsay">
                                    <p class="au_input"><em class="pub_ico arr_drop dropout fr"></em><em class="font_c_gray">章节摘要</em></p>
                                    <div class="toread"><textarea placeholder="请输入章节摘要20字以内" class="summary" maxlength="20"></textarea></div>
                                </div>
                            </div>
                        </div>
                        <div class="w_list clear">
                            <div class="minstar fl"></div>
                            <div class="w_con">
                                <div class="authorsay">
                                    <p class="au_input"><em class="pub_ico arr_drop dropout fr"></em><em class="font_c_gray">作者有话说</em></p>
                                    <div class="toread"><textarea placeholder="在这里输入对读者说的话5000字以内" class="write" name="AuthorDesc" maxlength="5000"></textarea></div>
                                </div>
                            </div>
                        </div>
                        <div class="w_list clear submit_model">
                            <div class="minstar fl">*</div>
                            <div class="w_con">
                                <div class="au_input publish_m radio_dom"><em class="font_c_gray">发布模式：</em><input type="radio" id="raVip" name="IsVIP" value="1">VIP<input type="radio" name="IsVIP" checked value="0">免费</div>
                            </div>
                        </div>
                        <div class="w_list clear submit_style">
                            <div class="minstar fl">*</div>
                            <div class="w_con">
                                <div class="au_input publish_s radio_dom"><em class="font_c_gray">发布方式：</em><span class="label" mode="2"><input type="radio" name="State" value="0">暂存草稿</span><span class="label focus" mode="1"><input type="radio" name="State" value="1" checked>立即发布</span></div>
                            </div>
                        </div>
                        <div class="w_list clear">
                            <div class="minstar fl"></div>
                            <div class="w_con">
                                <a href="javascript:;" class="upload_c btn_bg" onclick="add()" submit="add">上传章节</a>
                            </div>
                        </div>
                        <div class="w_list clear">
                            <div class="minstar fl"></div>
                            <div class="w_con">
                                <div class="upload_warn">
                                    <p class="warn_p"><em class="pub_ico ico_err" style="margin-left:0;"></em>上传章节说明 </p>
                                    <p>1、编辑、移动、删除章节在作品库中的作品列表里该作品的【章节管理】里。</p>
                                    <p>2、分卷不能移动，创建分卷、章节的顺序即为分卷、章节在目录中的展示顺序，也就是书的顺序。</p>
                                    <p>3、程序能处理绝大多数文本格式的排版，但请不要录入带硬回车换行的作品</p>
                                    <p>4、添加的章节会被程序识别为作品或当前卷的最新一章，请注意选择章节所在卷。章节请按顺序输入，不要颠倒。</p>
                                    <p>5、章节名字应与内容相符，不具有文学性、故意夸大其词的广告性、政治性以及恶搞性章节名将会被删除。</p>
                                    <p>6、上传的章节内容必须与符合98k收录标准，不符合收录标准的作品将被禁阅或删除。</p>
                                    <p>7、凡是六小时内重复上传新章节、单章字数低于2000字将不在首页更新列表，以及分类更新列表内显示更新情况(漫画作品除外)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="~/js/hm.js"></script>

    <script src="~/jquery-3.1.1.js" type="text/javascript"></script>
    @*<script src="~/js/jquery-1.8.3.min.js" type="text/javascript"></script>*@
    <script type="text/javascript" src="~/js/public.dialog.js"></script>
    <div class="mdialog" id="publicDialog" style="display: none; top: 46px;">
        <h2><a href="javascript:;" title="关闭" class="pub_ico btn_close md_close fr"></a><span class="md_tit">保存到草稿箱</span></h2>
        <div class="mdchange mdlist">
            <div class="md_tips">操作错误提示信息</div>
            <p align="center"><span class="btn_c_g btn_move btnSure">确定</span></p>
        </div>
        <div class="mdconfirm mdlist">
            <div class="md_tips">您好，您刚刚编辑的章节还没有保存，是否保存到草稿箱？</div>
            <div class="md_btn"><span class="btn_c_g md_sure btnSure" btntype="save">确定</span><span class="btn_c_g md_cancel btnCancel">取消</span></div>
        </div>
        <div class="mdmove mdlist">
            <div class="volume select_dom">
                <p class="select_nav"><em class="cor_gary">分卷</em><em class="voname sel_con"></em></p>
                <div class="option" style="max-height: 448px; display: none;"></div>
            </div>
            <div class="mdchapter clear">
                <div class="chaptername select_dom fl">
                    <em class="cor_gary">章节</em>
                    <p class="select_nav"><em class="sel_con"></em></p>
                    <div class="option" style="max-height: 98px; display: none;"></div>
                </div>
                <div class="chapterps select_dom fr">
                    <em class="cor_gary">位置</em>
                    <p class="select_nav"><em class="sel_con">章节之前</em></p>
                    <ul class="option" style="display: none;"><li>章节之前</li><li>卷末</li></ul>
                </div>
            </div>
            <p align="center" class="align"><a href="javascript:;" class="btn_c_g btn_move btnSure">移动</a></p>
        </div>
    </div>
    <div id="publicDialogbg" style="height: 1395px;"></div>

    <script type="text/javascript" src="~/js/public.js"></script>
    <script type="text/javascript" src="~/js/laydate.js"></script>
    @*<script type="text/javascript" src="~/js/editor.js"></script>*@
    <script type="text/javascript" src="~/js/tongji.js"></script>
</body>
</html>
<script>
    //反填分卷名
    $(function () {
        $.ajax({
            url: "/AuthorLR/GetVid",
            type: "post",
            dataType: "json",
            success: function (data) {
                console.log(data);
                $("[name=VolumeName]").val(data.VolumeName);
            }
        })
    })
    //修改
    function Upt() {
        $.ajax({
            url: "/AuthorLR/VolumesUpdate",
            type: "post",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data > 0) {
                    alert("修改成功");
                }
                else {
                    alert("修改失败");
                }
            }
        })
    }

    $(function () {
        $.ajax({
            url: "/AuthorLR/GetVolumes?PId=0",
            type: "post",
            dataType: "json",
            success: function (data) {
                console.log(data);
                for (var i = 0; i < data.length; i++) {
                    var op = '<option value="' + data[i].VolumeId + '">' + data[i].VolumeName + '</option>'
                    $("[name=VolumeId]").append(op);
                    var li = '<li class="l_tome"  onclick="showVId(' + data[i].VolumeId + ')" tomeno="100" tomelevel="0"><p class="art_tit"><em class="l_name" title = "' + data[i].VolumeName + '" >' + data[i].VolumeName + '</em></p > <div class="chapterlist" style="max-height: 433px;"><ul class="art_con"><li class="add_chapter"></li></ul></div></li >';
                    $("#listVolumes").append(li);
                }

            }
        })
    })
    function showVId(vid) {
        $("[name=VolumeId]").val(vid);
    }
    //创建章节
    function add() {
        $.ajax({
            url: "/AuthorLR/UpdateChapters",
            type: "post",
            dataType: "json",
            data: $("#form0").serialize(),
            success: function (data) {
                console.log(data);
                if (data > 0) {
                    alert("..成功");
                }
                else {
                    alert("error");
                }

            }
        })
    }

</script>