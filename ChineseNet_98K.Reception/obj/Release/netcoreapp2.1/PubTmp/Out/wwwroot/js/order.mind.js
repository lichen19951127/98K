/* zongheng PC 2018 Copyright (c) 2018 (zongheng FETEAM) lastUpdate: 2018-08-13 16:35:44*/
require(["widget"],function(c){var o={rootlist:{},startIndex:1,selectChapters:[],nextGroup:{},tomeGroup:{},total:{chapters:[],txt:0,totalPrice:0,ordered:0},options:{txt:0,totalPrice:0,ordered:0},setFormValue:function(t){return{txt:parseInt(t.attr("data-wordNum")),totalPrice:parseInt(t.attr("data-price")),length:parseInt(t.attr("data-length"))}},addSingle:function(t){this.options.totalPrice+=parseInt($(t).attr("data-price")),this.options.txt+=parseInt($(t).attr("data-wordnum")),this.testTomeChecked($(t).attr("data-tomeId")),$(".muchapter-checkbox:checked").attr("checked",!1),this.rebuildForm()},removeSingle:function(t){$("#select_all:checked").attr("checked",!1),$(".muchapter-checkbox:checked").attr("checked",!1),$('.tome-checkbox[data-tomeId="'+$(t).attr("data-tomeId")+'"]:checked').attr("checked",!1),this.options.totalPrice-=parseInt($(t).attr("data-price")),this.options.totalPrice<0&&(this.options.totalPrice=0),this.options.txt-=parseInt($(t).attr("data-wordnum")),this.options.txt<0&&(this.options.txt=0),this.rebuildForm()},addMuti:function(t,e){var a=this;!0===e&&a.clear(),$(t).each(function(){!0!==this.disabled&&!1===$(this).is(":checked")&&(a.options.totalPrice+=parseInt($(this).attr("data-price")),a.options.txt+=parseInt($(this).attr("data-wordnum")),$(this).attr("checked",!0))})},setCheckedMuti:function(t){t.each(function(){!0!==this.disabled&&!1===$(this).is(":checked")&&$(this).attr("checked",!0)})},removeMuti:function(t,e){var a=this;if(!e)e=a.startIndex;for(var r=0;r<t;r++){var o=parseInt(e)+r,c=$('.chapter-checkbox[data-index="'+o+'"]');!0!==c[0].disabled&&!0===c.is(":checked")?(c.attr("checked",!1),a.options.totalPrice-=parseInt(c.attr("data-price")),a.options.txt-=parseInt(c.attr("data-wordnum"))):a.options.ordered--}this.rebuildForm()},testAllChecked:function(){$(".tome-checkbox:checked").length+$(".tome-checkbox:disabled").length===$(".tome-checkbox").length?$("#select_all").attr("checked",!0):$("#select_all").attr("checked",!1)},testTomeChecked:function(t){$('.chapter-checkbox[data-tomeId="'+t+'"]:checked').length===this.tomeGroup[t].chapters.length&&$('.tome-checkbox[data-tomeId="'+t+'"][disabled!=true]').attr("checked",!0),this.testAllChecked()},testMutiChecked:function(t){$(".chapter-checkbox[data-n"+t+"]:checked").length+$(".chapter-checkbox[data-n"+t+"]:disabled").length==t&&$('.muchapter-checkbox[value="'+t+'"]').attr("checked",!0)},addTome:function(t){var e=$(t).attr("data-tomeId");if(0===$('.chapter-checkbox:checked[data-tomeId="'+e+'"]').length){var a=this.setFormValue($(t));this.options.totalPrice+=a.totalPrice,this.options.txt+=a.txt,$('.chapter-checkbox[data-tomeid="'+t.value+'"][disabled!="true"]').attr("checked",!0)}else this.addMuti($('.chapter-checkbox[data-tomeId="'+e+'"]'));$(".tome-checkbox:checked").length&&this.rebuildForm(),this.testAllChecked()},removeTome:function(t){var e=this.setFormValue($(t));this.options.totalPrice-=e.totalPrice,this.options.txt-=e.txt,$('.chapter-checkbox[data-tomeid="'+t.value+'"]').attr("checked",!1),$("#select_all:checked").attr("checked",!1),this.rebuildForm()},addNextn:function(t){var e=this;e.clear();var a=t.value,r=$('li[data-cid="'+$("body").attr("data-frcid")+'"]').find(".chapterName").children("span").html();for(var o in 0===e.nextGroup[a].chapters.length&&c.Alert("这位大爷！后面的 "+a+" 章您都特喵的买过了口牙。","从 "+r+" 这章开始计算的",function(){$('.muchapter-checkbox[value="'+a+'"]').attr("checked",!1),$("#select_all").attr("checked",!1)}),this.setCheckedMuti($(".chapter-checkbox[data-n"+a+'="true"]')),e.tomeGroup)e.testTomeChecked(o);this.options=this.setFormValue($(t)),this.rebuildForm()},removeNextn:function(t){this.clear(!0)},addAll:function(){this.setCheckedMuti($(".tome-checkbox,.chapter-checkbox"));var t=this.setFormValue($("#select_all"));this.options=$.extend(this.options,t),this.rebuildForm()},buildSelect:function(){var t=this;(new Date).getTime();t.selectChapters=[],$(".chapter-checkbox:checked").each(function(){t.selectChapters.push(this.value)})},testForum:function(t){0<$(".chapter-checkbox:checked").length?$("#orderButton").addClass("order_confirm"):$("#orderButton").removeClass("order_confirm")},rebuildForm:function(){$("#oform_length").html($(".chapter-checkbox:checked").length+"章"),$("#oform_txtnum").html(this.options.txt+"字"),$("#oform_money").html(this.options.totalPrice),this.testForum()},setChapterOrdered:function(t){for(var e=0;e<t.length;e++)$('.chapterLine[data-cid="'+t[e]+'"]').addClass("disabled").find(".orderStatus").html("已订阅"),$('.chapter-checkbox[data-cid="'+t[e]+'"]').attr("disabled",!0);this.clear(!0),this.init()},clear:function(t){$(".chapter-checkbox,#select_all,.tome-checkbox").attr("checked",!1),this.selectChapters=[],this.options.totalPrice=0,!(this.options.txt=0)===t&&this.rebuildForm()},init:function(e){var s=this,d=s.rootlist;$("#quick_select_panel,#order_chapterlist_wrap").hide(),$("#order_chapterlist_loading").show();var h=$(".chapter-checkbox").length,a=$(".chapter-checkbox:disabled").length,t=$("body").attr("data-frcid"),r=$('.chapter-checkbox[value="'+t+'"]');s.startIndex=parseInt(r.attr("data-index")),$('.muchapter-checkbox[value="all"]').attr("value",h-parseInt(o.startIndex)+1),s.mutiNumList=[],$(".muchapter-checkbox").each(function(){s.nextGroup[$(this)[0].value]={chapters:[],txt:0,totalPrice:0,ordered:0},s.mutiNumList.push(parseInt($(this)[0].value))}),$(".tome-checkbox").each(function(){s.tomeGroup[$(this)[0].value]={chapters:[],txt:0,totalPrice:0,ordered:0};var t=$(this).attr("data-tomeId"),e=$('.orderSign[data-tomeId="'+t+'"]').attr("data-orderLength");$(this).attr("data-tomelength")==e&&$(this).attr("disabled",!0).closest(".tome_line").addClass("disabled")});(new Date).getTime();!function(t){h<=t?($(".muchapter-checkbox").each(function(){$(this).attr("data-price",s.nextGroup[this.value].totalPrice),$(this).attr("data-length",s.nextGroup[this.value].chapters.length),$(this).attr("data-wordnum",s.nextGroup[this.value].txt),0===s.nextGroup[this.value].chapters.length&&($(this).attr("disabled",!0),$(this).parent("label").addClass("disabled"))}),$(".tome-checkbox").each(function(){$(this).attr("data-price",s.tomeGroup[this.value].totalPrice),$(this).attr("data-length",s.tomeGroup[this.value].chapters.length),$(this).attr("data-wordnum",s.tomeGroup[this.value].txt),0===s.tomeGroup[this.value].chapters.length&&$(this).attr("disabled",!0).closest(".tome_line").addClass("disabled")}),$("#select_all").attr("data-price",s.total.totalPrice),$("#select_all").attr("data-length",h),$("#select_all").attr("data-wordnum",s.total.txt),$("#order_chapterlist_loading").hide(),$("#quick_select_panel,#order_chapterlist_wrap").show(),r.offset().top>$(window).height()-150&&$("html,body").scrollTop(r.offset().top-85),h===a?$("#select_all").attr("disabled",!0):"checklast"===e&&!0!==$("#order-sel-lastall")[0].disabled&&($("#order-sel-lastall").attr("checked",!0),s.addNextn($("#order-sel-lastall")[0]))):(function(t){setTimeout(function(){$("#order_chapterlist_loading").text($(t).attr("data-index")+"/"+h)},100);var e=parseInt($(t).attr("data-index")),a=$(t),r=parseInt(a.attr("data-price")),o=parseInt(a.attr("data-wordnum")),c=a.attr("data-tomeId");!0!==t.disabled&&(s.tomeGroup[c].chapters.push(t.value),s.tomeGroup[c].totalPrice+=r,s.tomeGroup[c].txt+=o,s.total.chapters.push(t.value),s.total.totalPrice+=r,s.total.txt+=o,d[t.value]={},d[t.value].chapterId=t.value,d[t.value].price=r,d[t.value].word=o,d[t.value].checked=!1);for(var i=0;i<s.mutiNumList.length;i++)e>=s.startIndex&&e<=s.mutiNumList[i]+s.startIndex-1&&!0!==t.disabled&&($(t).attr("data-n"+s.mutiNumList[i],"true"),s.nextGroup[s.mutiNumList[i]].chapters.push(t.value),s.nextGroup[s.mutiNumList[i]].totalPrice+=r,s.nextGroup[s.mutiNumList[i]].txt+=o)}($(".chapter-checkbox").eq(t)[0]),arguments.callee(t+1))}(0),window.OrderUtil=o}},e=$("body").attr("bookId"),a=$("body").attr("data-frcid");o.init("checklast"),$(".muchapter-checkbox").click(function(){return $(this).closest("li").siblings("li").find("input.muchapter-checkbox").attr("checked",!1),!0===$(this).is(":checked")?(o.addNextn(this),void $(this).next().removeClass("em_checked")):(o.removeNextn(this),void $(this).next().addClass("em_checked"))}),$(".tome-checkbox").click(function(){if($(".muchapter-checkbox:checked").attr("checked",!1),!0===$(this).is(":checked"))return o.addTome(this),void $(this).next().removeClass("em_checked");o.removeTome(this),$(this).next().addClass("em_checked")}),$("#select_all").click(function(){if($(".muchapter-checkbox:checked").attr("checked",!1),!0===$(this).is(":checked"))return o.addAll(),void $(this).next().removeClass("em_checked");o.clear(!0),$(this).next().addClass("em_checked")}),$(".chapterLine").children(".holder").click(function(){}),$(".chapter-checkbox").click(function(){var t=$(this).closest("li").children(".holder");if(t.show(),setTimeout(function(){t.hide()},500),1==$(this).is(":checked"))return o.addSingle(this),void $(this).next().addClass("em_checked");o.removeSingle(this),$(this).next().removeClass("em_checked")}),$(".tomeSlider").click(function(){var t=$(this).attr("id");$("."+t).toggle();var e=$(this).children("span");e.text("收起"===e.text()?"展开":"收起"),$(this).children("em").toggleClass("down")}),UserUtil.addListener({initOrderPageMoney:function(t){$(".oform_usermoney").html(t.money)}});var r=new c.Custom({html:'<div class="orderWin_wrap"><div class="orderInfo"><ul>   <li class="ordernum">本次订阅：共 <b id="order-data-num">--</b> 章节</li>   <li class="orderpaynum">本次订阅将消耗 <b id="order-data-money">--</b> 纵横币</li></ul></div><div class="ordertips"><div class="orderError" id="order-tip-error"><em></em>余额不足</div><div id="order-tip-money" class="orderwn_usermoney"></div><div class="orderopt"><label><input type="checkbox" id="order-ckx-autoorder" value="1" checked="true"><em class="checkbox"></em>自动订阅最新章节</label></div></div><div class="ui_widget_conbtn clearfix">   <button class="confirm" id="order-btn-goorder" data-cb="confirm">确认支付</button>   <button class="confirm" id="order-btn-charge" data-cb="confirm">去充值</button></div></div>',id:"OrderConfirmDialog",tit:"订阅VIP章节",height:362});$("#order-ckx-autoorder").click(function(){!0!==$(this).is(":checked")?$(this).val(0):$(this).val(1)}),$("#orderButton").click(function(){0<$(".chapter-checkbox:checked").length&&(o.selectChapters=[],$(".chapter-checkbox:checked").each(function(){o.selectChapters.push(this.value)}),$("#order-data-num").html(o.selectChapters.length),$("#order-data-money").html(o.options.totalPrice));var t=parseInt($(".oform_usermoney").html());if(t>=o.options.totalPrice)$("#order-tip-money").html("当前余额："+t+" 纵横币"),$("#order-btn-goorder,.orderopt").show(),$("#order-btn-charge").hide(),$("#order-tip-error").hide();else{var e=o.options.totalPrice-t;$("#order-tip-money").html("当前余额："+t+" 纵横币，还需支付 <b>"+e+"</b> 纵横币"),$("#order-tip-error").show(),$("#order-btn-goorder,.orderopt").hide(),$("#order-btn-charge").show()}$(this).hasClass("order_confirm")&&($("#haha").attr("orderChapters",o.selectChapters.join(",")).html(o.selectChapters.join(",")),r.open())}),$("#order-btn-goorder").click(function(){r.loading(!0),setTimeout(function(){var t;t=o.selectChapters.join(","),$.ajax({type:"post",url:"/api/user/consume/order",data:{bookId:e,chapterids:t,autoOrder:$("#order-ckx-autoorder").val()},beforeSend:function(){r.loading(!0)},cache:!1,dataType:"json",error:function(){r.loading(!1),r.close(),c.Alert("出错了...")},timeout:6e4,success:function(t){t?(r.loading(!1),r.close(),202!==t.status&&201!==t.status?1===t.status?(c.Confirm({con:'<div class="order_success_pic"></div><p class="contit">订阅成功(oﾟvﾟ)ノ</p>',confirmTxt:"立即阅读",close:!0,cb:{confirm:function(){return location.href=Domain.bookHostName+"/chapter/"+e+"/"+a+".html?ver="+(new Date).getTime(),!0}}}),UserUtil.getUserInfo(),o.setChapterOrdered(o.selectChapters)):c.Alert(t.msg):c.Alert(t.msg,UserUtil.login)):c.Alert("出错了...")}})},1e3)}),$("#order-btn-charge").click(function(){window.open(Domain.payHostName),r.close(),c.Confirm({con:"在新打开的页面上完成充值操作",tip:"充值成功后可进行以下操作",beforeOpen:function(){},close:!0,confirmTxt:"继续购买",cancelTxt:"余额查询",cb:{confirm:function(){location.reload()},cancel:function(){location.href=Domain.homeHostName}}})})});