/* zongheng PC 2018 Copyright (c) 2018 (zongheng FETEAM) lastUpdate: 2018-08-21 14:43:54*/
define(["jquery","widget"],function(i,s){var t,e,o=i("body").attr("bookId"),n=i("body").attr("forumid"),r=(i("body").attr("threadid"),t=new RegExp("(^|&)"+"chapterId"+"=([^&]*)(&|$)"),null!=(e=window.location.search.substr(1).match(t))?unescape(e[2]):0),l=i("#JpostIpt"),c=i("textarea"),d=i("#Jcode input"),u=i("#JpostBtn"),f=i("#Jwords"),a=i("#Jcode").find(".refresh");function g(t){var e=t.replace(/<script.*?>.*?<\/script>/gi,"");return e=(e=e.replace(/<script.*?>/gi,"")).replace(/<\/script.*?>/gi,"")}i(".user-head img").error(function(){i(this).attr("src",UserUtil.defaultImg)}),i.fn.extend({insert:function(t){t=i.extend({text:"123"},t);var e=i(this)[0];if(document.selection)i(e).focus(),document.selection.createRange().text=t.text,i(e).focus();else if(e.selectionStart||"0"==e.selectionStart){var a=e.selectionStart,s=e.selectionEnd;e.scrollTop;e.value=e.value.substring(0,a)+t.text+e.value.substring(s,e.value.length)}else this.value+=t.text,this.focus();return i(this)}}),c.keyup(function(){var t=i(this),e=t.val().length,a=t.attr("data-maxLen");if(t.val(g(t.val())),a<e){var s=t.val().substring(0,a);t.val(s)}else 0<e&&(f.find("i").addClass("cor").text(e),0<d.val().length&&u.removeClass("gray"))," "!=t.val()&&0!=e||(u.addClass("gray"),f.find("i").removeClass("cor").text(e))}),d.keyup(function(){var t=i(this).val().length;0<t&&0<c.val().length&&u.removeClass("gray")," "!=i(this).val()&&0!=t||u.addClass("gray")}),i("#Jemoji").click(function(){var t=i(this).find(".emoji-popup");t.show(),t.find("em").unbind().click(function(t){t.stopPropagation();var e=i(this).attr("data-tit");c.insert({text:e});var a=c.val().length;0<d.val().length&&0<c.val().length&&u.removeClass("gray"),f.find("i").addClass("cor").text(a)})}),c.focus(function(){i("#Jemoji .emoji-popup").hide()}),a.click(function(){i("#Jcode").find("img").attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random()),d.val("").focus()}),u.click(function(){if(!i(this).hasClass("gray")){UserUtil.isLogin||UserUtil.login(),i("#Jemoji .emoji-popup").hide();var t=l.val(),e=g(c.val()),a=d.val();" "!=a.length?i.ajax({type:"post",url:"/api/thread/t/add",data:{forumId:n,bookId:o,title:t,content:e,verifyCode:a,chapterId:r},cache:!1,async:!0,dataType:"json",error:function(){s.Toast("系统错误，请稍后重试~")},timeout:1e4,success:function(t){1==t.status?s.Toast({txt:t.msg,time:3e3,onHide:function(){window.location.href=0==r?Domain.forumHostName+"/"+n+".html":Domain.forumHostName+"/chapterThread/"+n+"/"+r+".html"}}):"-101"==t.status||"202"==t.status?s.Toast({txt:t.msg,time:3e3,onHide:function(){UserUtil.login()}}):-1==t.status?(s.Toast(t.msg),i("#Jcode").find("img").attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random()),d.val("").focus()):s.Toast(t.msg)}}):s.Alert("验证码不能为空")}})});
