/* zongheng PC 2018 Copyright (c) 2018 (zongheng FETEAM) lastUpdate: 2018-11-29 14:37:25*/
require(["jquery","widget","forumsAction"],function(t,e,a){var s=t("body").attr("bookId"),r=t("body").attr("forumid"),i=t("body").attr("threadid"),o=t("#JtextareaReply"),l=t("#Jtextarea_1"),d="",n="",c="",f=t(".Jfor-user").html(),h=!1,m=0,u=function(){return"1"==t(".thr-detail").attr("data-sd")};if(!0===UserUtil.isLogin)n=UserUtil.user.nickName,c=UserUtil.user.userId,UserUtil.addListener({initThreadUserImage:function(){d=UserUtil.userInfo.image,o.find(".for-user-head").attr("src",d)}}),t(".for-user-head").error(function(){t(this).attr("src",UserUtil.defaultImg),d=UserUtil.defaultImg});else{o.find(".for-user-head").attr("src",UserUtil.defaultImg);o.find(".textarea-box").addClass("unlogin").html('你还未登录不能发表书评，点击 <i id="JLogin">[登录]</i> 或 <a id="JReg" href="https://passport.zongheng.com/webreg">[注册]</a> 发表评论。'),t("#JLogin").click(function(){UserUtil.login()})}function p(t){var e=t.replace(/<script.*?>.*?<\/script>/gi,"");return e=(e=e.replace(/<script.*?>/gi,"")).replace(/<\/script.*?>/gi,"")}function v(t){return t.replace(/[<>&"]/g,function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[t]})}function g(t,e){!0!==UserUtil.isLogin||e.hasClass("focus")||(t.focus(),e.addClass("focus")),t.blur(function(){e.removeClass("focus")})}t(".for-comment").click(function(){g(l,t(this))});var J={};function y(e){return(e=t.trim(e)).replace(/\[([^\[\]]+)\]/g,function(){var t=arguments[0];return'<em class="emoji_em '+J[t]+'"></em>'})}t("#Jemoji-list").find("em").each(function(e){var a=e+1,s=t(this).attr("data-tit");a<10&&(a="0"+a),J[s]="emoji_"+a});var b=0,x=["","楼主"];function C(a,o,l){t.ajax({type:"get",url:"/api/forums/details/postList",data:{bookId:s,forumId:r,refThreadId:i,isAllPost:a,sortType:l,postId:o},cache:!1,async:!0,dataType:"json",error:function(){""==o?t("#JthreadList").html('<div class="fail">加载失败，<i class="Jfail">点击重新载入~</i></div>'):t("#JmoreA").html('<div class="fail">加载失败，<i class="Jfail">点击重新载入~</i></div>'),t(".Jfail").click(function(){C(a,o,l)})},beforeSend:function(t){t.withCredentials=!0},xhrFields:{withCredentials:!0},crossDomain:!0,timeout:1e4,success:function(s){if(s&&s.data){h=s.data.isAdmin;var i=s.data.postList,d=s.data.postId,n="";if(t("#JthreadList .loading").remove(),null==i&&""==o)return t("#JthreadList").html('<div class="empty">'+x[a]+"还没有回复哦，快来抢沙发~</div>"),t("#JmoreA").html(""),void t("#Jreverse").hide();if(null!=i||null!=d||""==o){t("#Jreverse").show();var f=t(".Jfor-user").attr("data-userId");t.map(i,function(t,e){var a=Domain.homeHostName+"/show/userInfo/"+t.userId+".html";n+='<li class="clearfix"  data-threadId="'+t.threadId+'" data-userId="'+t.userId+'" data-nickname="'+t.nickName+'">',n+='<div class="for-rp-thread clearfix for-jb">',n+='<div class="user-head"><a href="'+a+'" target="_blank"><img src="http://static.zongheng.com/userimage'+t.userImgUrl+'" alt="" width="50" height="50">'+(0!=t.userLevel?'<em class="lv'+t.userLevel+'"></em>':"")+'<span><i class="star star'+t.fansScoreLevel+'"></i></span></a></div>',n+='<div class="for-rp-con user-rp-con">',n+='    <div class="name">'+t.nickName+(1==t.authorStatus?'<em class="for-label au">作者</em>':"")+(1==t.forumLeaderStatus?'<em class="for-label cir">圈主</em>':""),n+=f==t.userId?'<em class="for-label lz">楼主</em>':"",n+='        <div class="floor"><i>'+t.orderNum+"</i>楼</div>",n+="    </div>",n+='    <div class="dec clearfix JdecAll">',n+="        <p> "+(null==t.content?"":t.content)+"</p>",n+="    </div>",n+='    <div class="other clearfix">',n+='        <div class="date fl">'+getDateDiff(t.lastPostTime)+"</div>",n+='        <div class="fr for-list">',n+='<a class="for-inform for-le"><em></em>举报</a>',n+=1==h||c==t.userId?'<a class="for-del for-le Jfordel"></a>':"",n+='            <a class="for-praise for-le '+(1==t.isClickSupport?"uped":" ")+'"><em></em>'+t.upvoteNum+'</a><a class="for-comment for-le Jcomment" data-parentId="'+t.threadId+'" data-num="'+t.postNum+'" data-name="'+t.nickName+'"><em></em>'+t.postNum+"</a>",n+="        </div>",n+="    </div>",n+="</div>",n+="</div>",n+="</li>"}),""==o?t("#JthreadList").html(n):t("#JthreadList").append(n),null!=d?t("#JmoreA").html('<a class="more-link" href="javascript:void(0)">查看更多<em class="arrow-b"></em></a>'):null==d&&(""==o?t("#JmoreA").html(""):t("#JmoreA").html("没有更多内容了")),t(".user-head img").error(function(){t(this).attr("src",UserUtil.defaultImg)}),t(".JdecAll").each(function(){t(this).find("p").height()>75&&0==t(this).find("img").length&&(t(this).append('<div class="show-more"><span>展开<em></em></span></div>').addClass("hide"),t(this).removeClass("JdecAll"))}),t("#JmoreA .more-link").unbind().click(function(){C(a,d,l)}),t("#JthreadList .Jcomment").unbind().click(function(){var a=t(this),s=a.attr("data-parentId"),i=a.attr("data-name"),o=a.closest("li");if(a.hasClass("showList"))return a.removeClass("showList"),void o.find(".for-reply-list").remove();var l=o.index(),d=o.attr("data-userId");if(0==a.attr("data-num")){var n='<div class="for-reply-list" id="for-reply'+l+'">'+I(l,i,s,d)+"</div>";return o.append(n),a.addClass("showList"),void t("#JLogin"+l).click(function(){UserUtil.login()})}!function f(a,s,i){var o=a.closest("li");var l=o.attr("data-threadid");var d=o.attr("data-nickname");var n=o.attr("data-userId");var h=o.index();var m=a.closest("li");var u="";""==s&&m.append('<div class="for-reply-list" id="for-reply'+h+'"></div>');t.ajax({type:"get",url:"/api/forums/details/replyPostList",data:{forumId:r,replyPostParentId:l,lastReplyPostId:s},cache:!1,async:!0,dataType:"json",error:function(){e.Alert("请求失败，请稍后再试！")},timeout:1e4,success:function(e){a.addClass("showList");var r=e.data.replyPosts,o=e.data.postId;if(null==r||0==r.length)return""!=s&&null==o&&t("#Jmore"+h).html("没有更多内容了~"),void(""==s&&t("#for-reply"+h).append(u+I(h,d,l,n)));t.map(r,function(t,e){var a=Domain.homeHostName+"/show/userInfo/"+t.userId+".html";u+='<div class="for-reply-cel clearfix for-jb" data-userid ="'+t.userId+'" data-threadId = "'+t.threadId+'">',u+='    <div class="head"><a href="'+a+'" target="_blank"><img src="http://static.zongheng.com/userimage'+t.userImage+'" alt="" width="30" height="30"></a></div>',u+='    <div class="for-rp-con">',u+='        <h4 class="stit"><span class="s1">'+t.nickName+"：</span>",u+=null!=t.beRepliedNickName&&t.beRepliedNickName!=d?'<span class="s2">回复@'+t.beRepliedNickName+"</span>":" ",u+=t.content+"</h4>",u+='        <div class="other">',u+='            <div class="date fl">'+getDateDiff(t.createTime)+"</div>",u+='            <div class="fr for-list ">',u+='<a class="for-inform for-le"><em></em>举报</a>',u+=1==i||c==t.userId?'<a class="for-del for-le JforRpdel"></a>':"",u+='                <a class="for-comment for-le" data-name="'+t.nickName+'"><em></em></a>',u+="            </div>",u+="        </div>",u+="    </div>",u+="</div>"}),""==s&&null!=o&&(u+='<div class="more for-more" id="Jmore'+h+'"><a class="more-link" href="javascript:void(0)">查看更多<em class="arrow-b"></em></a></div>'),""==s?t("#for-reply"+h).append(u+I(h,d,l,n)):t("#Jmore"+h).before(u),""!=s&&null==o&&t("#Jmore"+h).html("没有更多内容了~"),t("#Jmore"+h+" .more-link").unbind().click(function(){f(a,o,i)}),t("#JLogin"+h).click(function(){UserUtil.login()}),t(".for-reply-cel .head img").error(function(){t(this).attr("src",UserUtil.defaultImg)}),t(".for-reply-list .for-comment").click(function(){var e=t(this).closest(".for-reply-cel").attr("data-userid");t("#Jpublish"+h).attr("data-userid",e);var a=t(this).attr("data-name");t("#textarea"+h).attr("data-renick",a),t("#textarea"+h).attr("placeholder","回复"+a),g(t("#textarea"+h),t(this))})}})}(a,"",h)})}else t("#JmoreA").html("没有更多内容了")}}})}function I(t,e,a,s){var r=" ";if(r+='<div class="thr-reply thr-reply-b">',r+='<div class="textarea-box '+(1!=UserUtil.isLogin||1==u()?"unlogin":"")+'" >',1!=UserUtil.isLogin?r+='你还未登录不能发表书评，点击 <i id="JLogin'+t+'">[登录]</i> 或 <a id="JReg" href="https://passport.zongheng.com/webreg">[注册]</a> 发表评论。':1==u()?r+="本帖已被锁定！":r+='<textarea class="txt Jtextarea-reply" id="textarea'+t+'" data-renick = "'+e+'"  placeholder="回复'+e+'"data-maxlen="200"></textarea>',r+="</div>",!0===UserUtil.isLogin){for(var i in r+='<div class="thr-publish clearfix Jthrpublish-2">',r+='<div class="fl post-code" id="Jpostcode'+t+'"><input type="text" class="Jipt"><div class="code"><img src="https://passport.zongheng.com/imgcapt?flag=pc&r='+Math.random()+'" alt="" class="Jcapt"><em class="refresh"></em></div></div>',r+='<div class="fr">',r+='     <div class="emoji" id="emojiShow'+t+'">',r+='        <div class="emoji-popup">',r+='           <i class="arrow-t"></i>',J)r+='    <em class="emoji_em '+J[i]+'" data-tit="'+i+'"></em>';r+="        </div>",r+="      </div>",r+='  <span id="words'+t+'" class="words"><i>0</i>/200</span><div class="btn gray" id="Jpublish'+t+'" data-rpid="'+a+'" data-userid="'+s+'">发表</div>',r+="</div>",r+="</div>"}return r+="</div>"}C(b,"",0),t("#Jreverse").click(function(){var e=t(this);e.hasClass("sort")?(e.html("<em></em> 正序").removeClass("sort").attr("data-sort",0),C(b,"",0)):(e.html("<em></em> 倒序 ").addClass("sort").attr("data-sort",1),C(b,"",1))}),t("#thread-tab span").click(function(){t(this).addClass("cur").siblings().removeClass("cur"),b=t(this).attr("type"),t("#JthreadList").html("<div class='loading'><em></em><span>正在读取中...</span></div>"),C(b,"",t("#Jreverse").attr("data-sort"))}),t("#JpostBtn").click(function(){var a=t(this);if(!a.hasClass("gray")){UserUtil.isLogin||UserUtil.login(),t("#Jemoji-list").hide();var s=p(t.trim(l.val()));m=parseInt(t(".JpostNum").html());var o=t("#Jcode").find(".Jipt");t.ajax({type:"post",url:"/api/thread/addPostThread",data:{forumId:r,content:s,refThreadId:i,verifyCode:t.trim(o.val())},dataType:"json",error:function(){e.Alert("请求失败，请稍后再试！")},beforeSend:function(t){t.withCredentials=!0},xhrFields:{withCredentials:!0},crossDomain:!0,success:function(r){if(o.val(""),1==r.status){e.Toast(r.msg),l.val(""),t(".JpostNum").text(++m),t("#Jwords").html("<i>0</i>/5000");var i="";i+='<div class="user-head"><img src="'+d+'" alt="" width="50" height="50"></div>',i+='<div class="for-rp-con no-bor">',i+='    <div class="name">'+n+'<em class="for-label weak">我的回复</em></div>',i+='    <div class="dec">'+y(v(s))+"</div>",i+='    <div class="other">',i+='        <div class="date fl">'+getDateDiff(new Date)+"</div>",i+="    </div>",i+="</div>",t("#JmyReply").html(i).show(),a.addClass("gray"),C(b,"",t("#Jreverse").attr("data-sort"))}else-1==r.status?(e.Toast(r.msg),o.focus()):202==r.status?e.Toast({txt:r.msg,time:3e3,onHide:function(){UserUtil.login()}}):e.Alert(r.msg)}})}}),t("#JthreadList").delegate(".btn","click",function(){!function(a){var s=a.index();if(t("#Jpublish"+s).hasClass("gray"))return;UserUtil.isLogin||UserUtil.login();t("#emojiShow"+s).find(".emoji-popup").hide();var o=p(t.trim(t("#textarea"+s).val())),l=t("#Jpublish"+s).attr("data-rpid"),c=t("#textarea"+s).attr("data-renick"),f=a.attr("data-nickname"),h=t("#Jpublish"+s).attr("data-userid"),u=t("#Jpostcode"+s).find(".Jipt"),g=t("#Jpostcode"+s).find(".Jcapt");t("#Jpostcode"+s).find(".refresh");t.ajax({type:"post",url:"/api/thread/addReplyPosts",data:{forumId:r,content:o,refThreadId:i,replyPostParentId:l,beRepliedUserId:h,verifyCode:t.trim(u.val())},dataType:"json",error:function(){e.Alert("请求失败，请稍后再试！")},success:function(a){if(u.val(""),g.attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random()),t("#Jpublish"+s).addClass("gray"),m=parseInt(t(".JpostNum").html()),t(".JpostNum").text(++m),1==a.status){e.Toast(a.msg);var r=t("#JthreadList li").eq(s).find(".Jcomment"),i=parseInt(r.text());i++,r.html("<em></em>"+i).attr("data-num",i),t("#textarea"+s).val(""),t("#words"+s).find("i").html("0").removeClass("cor");var l='<div class="for-reply-cel">';l+='<div class="head"><img src="'+d+'" alt="" width="30" height="30"></div>',l+='<div class="for-rp-con no-bor">',l+='    <h4 class="stit"><span class="s1">'+n+'</span><em class="for-label weak">我的回复</em><i class="gray">'+(c==f?"":"@"+c)+"</i>"+y(v(o))+"</h4>",l+='    <div class="other">',l+='        <div class="date fl">'+getDateDiff(new Date)+"</div>",l+="    </div>",l+="</div>",t("#for-reply"+s).find(".thr-reply-b").before(l)}else-1==a.status?(e.Toast(a.msg),u.val("").focus()):202==a.status?e.Toast({txt:a.msg,time:3e3,onHide:function(){UserUtil.login()}}):e.Alert(a.msg)}})}(t(this).closest("li"))}),t("#Jcode").find(".Jipt").focus(function(){t("#Jcode").find(".Jcapt").attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random())}),t("#JthreadList").delegate(".Jipt","focus",function(){t(this).parent().find(".Jcapt").attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random())}),t("#JthreadList,.thr-detail").delegate(".Jtextarea-reply","keyup",function(){var e=t(this),a=e.closest(".thr-reply"),s=a.find(".words"),r=(a.find(".emoji"),a.find(".btn")),i=e.val().length,o=e.attr("data-maxLen"),l=(a.find(".post-code"),a.find(".Jipt"));if(e.val(p(e.val())),i>o){var d=e.val().substring(0,o);e.val(d)}else i>0&&(s.find("i").addClass("cor").text(i),l.val().length>0&&r.removeClass("gray"))," "!=e.val()&&0!=i||(r.addClass("gray"),s.find("i").removeClass("cor").text(i))}),t("#JthreadList,.thr-detail").delegate(".Jipt","keyup",function(){var e=t(this),a=e.closest(".thr-reply"),s=a.find(".Jtextarea-reply"),r=a.find(".btn"),i=e.val().length;i>0&&s.val().length>0&&r.removeClass("gray")," "!=e.val()&&0!=i||r.addClass("gray")}),t("#JthreadList,.thr-detail").delegate(".refresh","click",function(){var e=t(this).closest(".thr-reply"),a=(e.find(".post-code"),e.find(".Jipt"));e.find(".Jcapt").attr("src","https://passport.zongheng.com/imgcapt?flag=pc&r="+Math.random()),a.val("").focus()}),t("#JthreadList,.thr-detail").delegate(".emoji","click",function(){if(1!=u()){t(this).find(".emoji-popup").show();var e=t(this).closest(".thr-reply"),a=e.find(".words"),s=e.find(".btn"),r=e.find(".Jtextarea-reply");t(this).find(".emoji-popup").find("em").unbind().click(function(e){e.stopPropagation();var i=t(this).attr("data-tit");r.insert({text:i});var o=r.val().length;self.code?self.code.val().length>0&&r.val().length>0&&s.removeClass("gray"):r.val().length>0&&s.removeClass("gray"),a.find("i").addClass("cor").text(o)})}}),t("#JthreadList,.thr-detail").delegate(".Jtextarea-reply","focus",function(){t(this).closest(".thr-reply").find(".emoji-popup").hide()}),t.fn.extend({insert:function(e){e=t.extend({text:"123"},e);var a=t(this)[0];if(document.selection)t(a).focus(),document.selection.createRange().text=e.text,t(a).focus();else if(a.selectionStart||"0"==a.selectionStart){var s=a.selectionStart,r=a.selectionEnd;a.scrollTop;a.value=a.value.substring(0,s)+e.text+a.value.substring(r,a.value.length)}else this.value+=e.text,this.focus();return t(this)}}),t("body").delegate(".for-jb","mouseover",function(e){e.stopPropagation(),t(this).find(".for-reply-cel").removeClass("jbshow"),t(this).addClass("jbshow").siblings().removeClass("jbshow"),t(this).siblings().find(".for-reply-cel").removeClass("jbshow")}),t("body").delegate(".for-jb","mouseout",function(e){e.stopPropagation(),t(this).removeClass("jbshow")}),t("#JthreadList").delegate(".show-more","click",function(){var e=t(this).parent();e.hasClass("hide")?(t(this).html("<span>收起<em></em></span>"),e.removeClass("hide")):(t(this).html("<span>展开<em></em></span>"),e.addClass("hide"))}),t(".forums-btn").click(function(){if(!0===UserUtil.isLogin){var e=t(".thr-textarea").offset().top-80;window.scrollTo(0,e),t(".thr-textarea").find("textarea").focus()}else UserUtil.login()}),t(".for-reset-btn").click(function(){var e=t(this).parent();e.hasClass("show")?e.removeClass("show"):e.addClass("show")}),require(["forumsAction"],function(a){t("#JthrCollect").click(function(){var s=t(this);1!=u()&&(s.hasClass("collected")?a.userAct("x",i,function(t){e.Toast(t),s.removeClass("collected")}):a.userAct("f",i,function(t){e.Toast(t),s.addClass("collected")}))}),t(".thr-detail").delegate(".Jdel","click",function(){t(this).closest(".for-reset").removeClass("show"),a.deleteThrForum(i,function(t){e.Toast(t),window.location.href="http://forum.zongheng.com/"+r+".html"})}),t(".thr-detail").delegate(".Jfordel","click",function(){a.deleteThrUser(i,function(t){e.Toast(t),window.location.href="http://forum.zongheng.com/"+r+".html"})}),t("#JthreadList").delegate(".Jfordel","click",function(){var s=t(this).closest("li"),r=s.attr("data-threadId"),i=s.attr("data-userId");c!=i?a.deleteThrForum(r,function(a){e.Toast(a),s.remove(),0==t("#JthreadList li").length&&t("#JthreadList").html('<div class="empty">'+x[b]+"还没有回复哦，快来抢沙发~</div>")}):a.deleteThrUser(r,function(a){e.Toast(a),s.remove(),0==t("#JthreadList li").length&&t("#JthreadList").html('<div class="empty">'+x[b]+"还没有回复哦，快来抢沙发~</div>")})}),t("#JthreadList").delegate(".JforRpdel","click",function(){var s=t(this),r=s.closest(".for-reply-cel"),i=s.closest("li"),o=r.attr("data-threadId"),l=r.attr("data-userId"),d=i.find(".Jcomment"),n=parseInt(d.attr("data-num"));c!=l?a.deleteThrForum(o,function(t){e.Toast(t),r.remove()}):a.deleteThrUser(o,function(t){e.Toast(t),r.remove(),d.html("<em></em>"+--n).attr("data-num",n)})}),t("body").delegate(".for-inform","click",function(){if(1!=u()){var s=t(this).closest("#JthreadList li").attr("data-threadId")||i;a.userAct("r",s,function(t){e.Toast(t)})}}),t("body").delegate(".for-praise","click",function(){if(1!=u()){var s=t(this);if(!s.hasClass("uped")){var r=parseInt(s.text()),o=s.closest("#JthreadList li").attr("data-threadId")||i;a.userAct("u",o,function(t){e.Toast(t),r++,s.addClass("uped popin").html("<em></em>"+r),setTimeout(function(){s.removeClass("popin")},500)})}}}),t(".thr-detail").delegate(".Jjh","click",function(){var s=t(this);s.closest(".for-reset").removeClass("show"),s.hasClass("jhed")?a.forumAct("q",i,function(a){e.Toast(a),s.removeClass("jhed"),s.text("精华"),t(".aLabel").find(".aJh").remove()}):a.forumAct("r",i,function(a){e.Toast(a),s.addClass("jhed"),s.text("取消加精"),t(".aLabel").prepend('<em class="jh aJh">精华</em>')})}),t(".thr-detail").delegate(".Jtop","click",function(){var s=t(this);s.closest(".for-reset").removeClass("show"),s.hasClass("toped")?a.forumAct("x",i,function(t){e.Toast(t),s.removeClass("toped"),s.text("置顶")}):a.forumAct("s",i,function(t){e.Toast(t),s.addClass("toped"),s.text("取消置顶")})}),t(".thr-detail").delegate(".Jsd","click",function(){var s=t(this);s.closest(".for-reset").removeClass("show");o.find(".textarea-box").html();s.hasClass("sded")?a.forumAct("z",i,function(a){e.Toast(a),t(".thr-detail").attr("data-sd",0),s.removeClass("sded").text("锁帖"),o.find(".textarea-box").removeClass("unlogin"),t(".textarea-box").each(function(){t(this).removeClass("unlogin")})}):a.forumAct("l",i,function(a){e.Toast(a),t(".thr-detail").attr("data-sd",1),s.addClass("sded").text("取消锁帖"),o.find(".textarea-box").addClass("unlogin"),t(".textarea-box").each(function(){t(this).addClass("unlogin")})})}),t(".thr-comment").delegate(".Jjy","click",function(){var e={},s=t(this);e.tId=i,e.tName=f,e.userId=t(".Jfor-user").attr("data-userId"),a.getJybox(s,e,!0)})})});
